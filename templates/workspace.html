<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Isolated Workspace</title>

  <!-- Smooth modern font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', Arial, sans-serif;
    }

    /* OUTER BACKGROUND */
    body {
      background: white;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* MAIN 3D BOX */
    #workspace {
      width: 80%;
      max-width: 650px;
      background: #e6e6e6;  /* Deskhop light grey */
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      box-shadow:
        0 12px 26px rgba(0,0,0,0.20),
        0 6px 12px rgba(0,0,0,0.12);
      transition: filter 0.25s;
    }

    h1 {
      margin-bottom: 10px;
      font-weight: 600;
      color: #333;
    }

    p {
      color: #444;
      margin-bottom: 25px;
      font-size: 15px;
    }

    /* MINT GREEN BUTTONS */
    button {
      padding: 12px 25px;
      margin: 10px 0;
      width: 70%;
      border: none;
      border-radius: 8px;
      background: #7ed9a7;       /* Mint green */
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background: #6ac791;
    }

    /* LOCKSCREEN */
    #lockscreen {
      position: fixed;
      top: 0; left: 0;
      height: 100vh; width: 100vw;
      background: rgba(0,0,0,0.7);
      color: white;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-size: 20px;
      z-index: 9999;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>

<div id="workspace">
  <h1>Welcome to Your Workspace</h1>
  <p>Please stay in this environment until your session is complete.</p>

  <!-- Enter fullscreen button -->
  <button id="enter-fullscreen">Enter Fullscreen & Start</button>

  <!-- End session -->
  <form action="{{ url_for('booking.end_session', booking_id=booking_id) }}" method="get">
    <button type="submit">End Session</button>
  </form>

  <!-- Pause session -->
  <form action="{{ url_for('booking.pause_session', booking_id=booking_id) }}" method="get">
    <button type="submit">Pause Session</button>
  </form>
</div>

<!-- OVERLAY -->
<div id="lockscreen">
  <h2>Session Paused</h2>
  <p>Your session has been paused.</p>
</div>

<script>
  const workspace = document.getElementById('workspace');
  const lockscreen = document.getElementById('lockscreen');
  const fullscreenBtn = document.getElementById('enter-fullscreen');

  const IDLE_TIME = 10; 
  let idleTimer = null;

  // ==============================
  // LOGGING API
  // ==============================
  async function logUserEvent(evt, details="") {
      try {
          await fetch("/booking/api/log_event", {
              method: "POST",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify({ event: evt, details })
          });
      } catch(e) { console.warn("Log failed", e); }
  }

  // ===============================
  // IDLE TRACKING
  // ===============================
  function resetIdle() {
    clearTimeout(idleTimer);
    logUserEvent("idle_reset");

    idleTimer = setTimeout(() => {
      logUserEvent("idle_trigger");
      workspace.style.filter = "blur(8px)";
      lockscreen.style.display = "flex";
      const pauseURL = "{{ url_for('booking.pause_session', booking_id=booking_id) }}?reason=idle";
      setTimeout(() => window.location.href = pauseURL, 400);
    }, IDLE_TIME * 1000);
  }

  // ===============================
  // FULLSCREEN ENTER
  // ===============================
  fullscreenBtn.addEventListener('click', () => {
    if (workspace.requestFullscreen) workspace.requestFullscreen();
    fullscreenBtn.style.display = 'none';
    logUserEvent("fullscreen_enter");
    resetIdle();
  });

  // ===============================
  // MOUSE + KEY ACTIVITY → reset idle
  // ===============================
  ["mousemove", "keydown", "wheel", "touchstart", "mousedown"].forEach(evt => {
    window.addEventListener(evt, resetIdle, { passive: true });
  });

  // ===============================
  // FULLSCREEN EXIT → pause session
  // ===============================
  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
      logUserEvent("fullscreen_exit");
      workspace.style.filter = "blur(6px)";
      lockscreen.style.display = "flex";
      const pauseURL = "{{ url_for('booking.pause_session', booking_id=booking_id) }}?reason=fullscreen_exit";
      setTimeout(() => window.location.href = pauseURL, 400);
    }
  });

  // ===============================
  // FORBIDDEN KEYS
  // ===============================
  document.addEventListener('keydown', e => {
    const forbidden = ["Escape", "F11", "F12", "F5"];
    if (forbidden.includes(e.key)) {
        logUserEvent("forbidden_key", `Pressed ${e.key}`);
        e.preventDefault();
    }

    if (e.ctrlKey && ["T","W","N","R"].includes(e.key.toUpperCase())) {
        logUserEvent("forbidden_key", `Pressed Ctrl+${e.key.toUpperCase()}`);
        e.preventDefault();
    }
  });

  window.addEventListener('contextmenu', e => {
      e.preventDefault();
      logUserEvent("forbidden_key", "Right click blocked");
  });

  resetIdle();
</script>


</body>
</html>
